<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3D Print Sydney — Application Guide</title>
    <style>
      :root {
        --bg: #0b0c0e;
        --panel: #111216;
        --muted: #a0a4ad;
        --text: #e8e9ec;
        --accent: #7aa2f7;
        --accent-2: #a6da95;
        --warning: #f6c177;
        --danger: #f7768e;
        --code-bg: #0f1115;
        --border: #1a1c21;
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(120deg, #0b0c0e, #12141a 40%, #0b0c0e);
        color: var(--text);
      }
      header {
        position: sticky; top: 0; z-index: 10;
        background: rgba(17,18,22,0.85);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid var(--border);
        padding: 14px 20px;
      }
      header h1 { margin: 0; font-size: 18px; letter-spacing: 0.3px; }
      header .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
      .container { display: grid; grid-template-columns: 280px 1fr; gap: 0; }
      nav {
        position: sticky; top: 60px; align-self: start;
        max-height: calc(100vh - 60px);
        overflow: auto;
        padding: 16px;
        border-right: 1px solid var(--border);
        background: rgba(17,18,22,0.5);
      }
      nav h3 { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.18em; margin: 18px 0 8px; }
      nav a { display: block; color: #c8ccdb; text-decoration: none; padding: 6px 8px; border-radius: 8px; font-size: 13px; }
      nav a:hover { background: rgba(122,162,247,0.08); color: var(--accent); }
      main { padding: 24px 28px; }
      section { margin: 28px 0 36px; }
      section h2 { font-size: 20px; margin: 0 0 8px; }
      section h3 { font-size: 16px; margin: 20px 0 8px; color: var(--accent-2); }
      p { color: #d8dbe6; line-height: 1.6; margin: 8px 0; }
      ul { margin: 8px 0 12px 22px; color: #d8dbe6; }
      li { margin: 6px 0; }
      .callout { border: 1px solid var(--border); background: rgba(255,255,255,0.03); padding: 14px; border-radius: 10px; }
      code, .code-inline { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: var(--code-bg); color: #eaf2ff; padding: 1px 5px; border-radius: 5px; }
      pre { background: var(--code-bg); padding: 12px; border-radius: 10px; overflow: auto; border: 1px solid var(--border); }
      .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
      .kv { border: 1px solid var(--border); border-radius: 10px; padding: 12px; background: rgba(255,255,255,0.03); }
      .kv h4 { margin: 0 0 8px; font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.16em; }
      .muted { color: var(--muted); }
      .ok { color: var(--accent-2); }
      .warn { color: var(--warning); }
      .bad { color: var(--danger); }
      .path { color: #cbd5ff; }
      .hr { height: 1px; background: var(--border); margin: 14px 0; }
      .small { font-size: 12px; }
      .tag { display: inline-block; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; background: rgba(255,255,255,0.06); font-size: 12px; color: #cad4ff; margin-right: 6px; }
    </style>
  </head>
  <body>
    <header>
      <h1>3D Print Sydney — Application Guide</h1>
      <div class="sub">A navigable overview of features, data flow, and implementation details (local‑first Next.js + SQLite).</div>
    </header>
    <div class="container">
      <nav>
        <h3>Start</h3>
        <a href="#start-here">Start Here</a>
        <a href="#system-overview">System Overview</a>
        <a href="#tech-stack">Tech Stack</a>
        <a href="#data-persistence">Data Persistence</a>
        <h3>Domain & Data</h3>
        <a href="#core-entities">Core Entities</a>
        <a href="#feature-map">Feature Map</a>
        <h3>Flows</h3>
        <a href="#flow-e2e">End‑to‑End Flow</a>
        <a href="#flow-attachments-pdf">Attachments & PDF</a>
        <a href="#flow-jobs-queue">Jobs & Queue Board</a>
        <a href="#flow-dashboard-reports">Dashboard & Reports</a>
        <a href="#flow-settings">Settings</a>
        <a href="#flow-stripe">Stripe Payments</a>
        <h3>API & App</h3>
        <a href="#api-surface">API Surface</a>
        <a href="#frontend-structure">Frontend Structure</a>
        <a href="#services-layer">Services Layer</a>
        <a href="#errors-logging">Errors & Activity Log</a>
        <h3>Ops</h3>
        <a href="#local-dev-lifecycle">Local Dev & Lifecycle</a>
        <a href="#data-safety">Data safety</a>
        <h3>Change Guide</h3>
        <a href="#where-to-edit">Where To Edit What</a>
        <a href="#glossary">Glossary</a>
      </nav>
      <main>
        <section id="start-here">
          <h2>Start Here</h2>
          <p>
            This console is a local‑first app for a boutique 3D‑printing studio. It manages quotes → invoices → payments → jobs, with client records, printer queues, attachments, PDFs, and reporting.
          </p>
          <div class="grid-2">
            <div class="kv">
              <h4>Source & Scripts</h4>
              <p><span class="tag">Next.js</span> <span class="tag">Prisma</span> <span class="tag">SQLite</span> <span class="tag">TanStack Query</span></p>
              <pre><code>npm install
npm run prisma
npm run db:migrate
npm run db:seed
npm run dev</code></pre>
            </div>
            <div class="kv">
              <h4>Data Folder</h4>
              <p>All state is under <span class="path">data/</span>:</p>
              <ul>
                <li><code>data/app.db</code> — SQLite database</li>
                <li><code>data/files/&lt;invoiceId&gt;/</code> — attachments</li>
                <li><code>data/pdfs/</code> — generated PDFs</li>
              </ul>
            </div>
          </div>
        </section>

        <section id="system-overview">
          <h2>System Overview</h2>
          <p>
            App Router route handlers under <code>src/app/api/**</code> handle all server logic, calling <code>src/server/services/**</code>. React components render pages under <code>src/app/**</code> and use TanStack Query to fetch JSON from the API.
          </p>
          <div class="callout small">
            <strong>Key files:</strong>
            <ul>
              <li><code>src/app/layout.tsx</code> — Providers + App shell</li>
              <li><code>src/components/layout/app-shell.tsx</code> — Sidebar + header + quick actions</li>
              <li><code>src/server/db/client.ts</code> — Prisma client</li>
              <li><code>prisma/schema.prisma</code> — Data model</li>
              <li><code>src/server/services/*</code> — Domain workflows</li>
              <li><code>src/lib/schemas/*</code> — Zod validation</li>
            </ul>
          </div>
        </section>

        <section id="tech-stack">
          <h2>Tech Stack</h2>
          <ul>
            <li><strong>Runtime/UI</strong>: Next.js App Router (React 19), shadcn UI, Tailwind</li>
            <li><strong>State</strong>: TanStack Query, React Hook Form + zod</li>
            <li><strong>Data</strong>: Prisma ORM (SQLite), Decimals for money</li>
            <li><strong>Files/PDF</strong>: Local FS under <code>data/</code>, Puppeteer for PDFs</li>
            <li><strong>Stripe</strong>: Optional Checkout + webhook; manual payments supported</li>
          </ul>
        </section>

        <section id="data-persistence">
          <h2>Data Persistence</h2>
          <p>
            All state is persisted locally. Restarting the app reuses the same <code>data/</code> folder. Remove <code>data/</code> to reset the environment.
          </p>
          <div class="grid-2">
            <div class="kv">
              <h4>Database</h4>
              <p><code>data/app.db</code> managed via Prisma migrations. Seeds set up defaults (materials, printers, settings).</p>
            </div>
            <div class="kv">
              <h4>Filesystem</h4>
              <p>Attachments and PDFs saved immediately; streamed and served via API to ensure safe path handling.</p>
            </div>
          </div>
        </section>

        <section id="core-entities">
          <h2>Core Entities (Prisma)</h2>
          <div class="grid-2">
            <div class="kv">
              <h4>Client</h4>
              <p>Contacts, terms, notes. 1‑* Quotes, Invoices, Jobs, Activity.</p>
            </div>
            <div class="kv">
              <h4>Quote</h4>
              <p>Draft → Pending → Accepted/Declined/Converted. Items with discounts, shipping, tax, totals.</p>
            </div>
            <div class="kv">
              <h4>Invoice</h4>
              <p>Pending/Overdue/Paid. Items, Payments, Attachments, Activity. May come from Quote.</p>
            </div>
            <div class="kv">
              <h4>Job</h4>
              <p>Linked to Invoice + Client; queued/printing/paused/completed/cancelled; per‑printer queue.</p>
            </div>
            <div class="kv">
              <h4>Printer</h4>
              <p>Active/Maintenance/Offline; jobs + activity for metrics and board columns.</p>
            </div>
            <div class="kv">
              <h4>Settings & NumberSequence</h4>
              <p>Business identity, tax, numbering prefixes, calculator config, shipping options, Stripe keys.</p>
            </div>
          </div>
        </section>

        <section id="feature-map">
          <h2>Feature Map</h2>
          <ul>
            <li><strong>Settings</strong> — Identity, numbering, calculator defaults, shipping, Stripe config.</li>
            <li><strong>Catalog</strong> — Materials, Product templates (fixed or calculated), Printers.</li>
            <li><strong>Clients</strong> — Directory + detail, notes, activity, totals.</li>
            <li><strong>Quotes</strong> — CRUD, duplicate, convert to invoice, PDF, status lifecycle.</li>
            <li><strong>Invoices</strong> — Editor, manual payments, Stripe checkout/webhook, attachments, PDF, revert.</li>
            <li><strong>Jobs</strong> — Auto‑create (policy), drag/drop board, status updates, metrics.</li>
            <li><strong>Dashboard</strong> — KPIs, revenue trend, quote pipeline, outstanding invoices, printer load, activity.</li>
            <li><strong>Reports</strong> — CSV exports (invoices, payments, jobs). Backup UI planned.</li>
          </ul>
        </section>

        <section id="flow-e2e">
          <h2>End‑to‑End Flow: Client → Quote → Invoice → Payment → Job</h2>
          <ol>
            <li><strong>Create Client</strong> in Clients. Data saved via <code>POST /api/clients</code>, activity logged.</li>
            <li><strong>Create Quote</strong> (templates + manual lines). Totals computed client‑side and validated server‑side.</li>
            <li><strong>Convert Quote to Invoice</strong> (or create Invoice directly). Numbering via <code>NumberSequence</code>.</li>
            <li><strong>Collect Payment</strong>:
              <ul>
                <li>Manual payment → records <code>Payment</code>, recomputes balance, may mark Paid.</li>
                <li>Stripe Checkout → session created; webhook confirms and calls <code>markInvoicePaid</code>.</li>
              </ul>
            </li>
            <li><strong>Auto‑Create Job</strong> per <code>Settings.jobCreationPolicy</code> (on payment or on invoice).</li>
            <li><strong>Manage Queue</strong> on Jobs board: reorder/move, update status (printing/paused/completed).</li>
          </ol>
          <pre><code>Client ──creates──▶ Quote ──convert──▶ Invoice ──paid──▶ Job
                                 │                 │
                                 └──── PDF ────────┘ (Stripe/manual)
</code></pre>
        </section>

        <section id="flow-attachments-pdf">
          <h2>Attachments & PDF</h2>
          <h3>Attachments</h3>
          <ul>
            <li>Uploaded files are stored at <code>data/files/&lt;invoiceId&gt;/&lt;filename&gt;</code>.</li>
            <li>API validates and records <code>Attachment</code> rows; deletions remove both DB row and file.</li>
          </ul>
          <h3>PDF Generation</h3>
          <ul>
            <li>Puppeteer renders HTML templates to A4 PDFs into <code>data/pdfs/</code>.</li>
            <li>Invoice/Quote detail provides a “Download PDF” action; generation is on demand.</li>
          </ul>
        </section>

        <section id="flow-jobs-queue">
          <h2>Jobs & Queue Board</h2>
          <p>Board columns: one per printer plus an Unassigned column. Each job card shows invoice + client, priority, status, estimates.</p>
          <ul>
            <li>Drag/drop reorders within or across printers; API persists <code>queuePosition</code> and <code>printerId</code>.</li>
            <li>Status updates set timestamps (started/completed) and log activity.</li>
            <li>Summary metrics (queued, active, total hours) are computed server‑side and shown on Dashboard.</li>
          </ul>
        </section>

        <section id="flow-dashboard-reports">
          <h2>Dashboard & Reports</h2>
          <ul>
            <li><strong>Dashboard</strong> aggregates revenue (30‑day + trend), outstanding invoices, quote pipeline, job load, and recent activity.</li>
            <li><strong>Reports</strong> lets you export CSVs for invoices, payments, and jobs filtered by date range.</li>
          </ul>
        </section>

        <section id="flow-settings">
          <h2>Settings</h2>
          <p>Single row config stores business identity, numbering prefixes, tax, payment terms, calculator defaults, shipping options, and optional Stripe keys.</p>
          <div class="callout small">
            <strong>Numbering</strong>: <code>NumberSequence</code> ensures atomic quote/invoice numbers with prefixes.
          </div>
        </section>

        <section id="flow-stripe">
          <h2>Stripe Payments</h2>
          <ul>
            <li>If Stripe keys exist in Settings, “Pay with Stripe” launches Checkout for the invoice balance.</li>
            <li>Webhook confirms the payment and records it; idempotency prevents duplicates.</li>
            <li>In absence of Stripe, “Mark Paid” records manual payment and sets status Paid when balanced.</li>
          </ul>
        </section>

        <section id="api-surface">
          <h2>API Surface (selected)</h2>
          <div class="grid-2">
            <div class="kv">
              <h4>Dashboard</h4>
              <code>GET /api/dashboard</code>
            </div>
            <div class="kv">
              <h4>Clients</h4>
              <code>GET/POST /api/clients</code><br/>
              <code>GET/PUT/DELETE /api/clients/[id]</code>
            </div>
            <div class="kv">
              <h4>Quotes</h4>
              CRUD plus <code>convert</code>, <code>duplicate</code>, <code>pdf</code>
            </div>
            <div class="kv">
              <h4>Invoices</h4>
              CRUD plus <code>mark-paid</code>, <code>mark-unpaid</code>, <code>revert</code>, <code>stripe-session</code>, <code>attachments</code>, <code>pdf</code>
            </div>
            <div class="kv">
              <h4>Jobs</h4>
              <code>GET /api/jobs</code>, <code>POST /api/jobs/reorder</code>, <code>PATCH /api/jobs/[id]/status</code>
            </div>
            <div class="kv">
              <h4>Reports</h4>
              <code>GET /api/export/invoices</code>, <code>/payments</code>, <code>/jobs</code>
            </div>
          </div>
          <div class="hr"></div>
          <p class="small muted">Responses are shaped as <code>{ data, error }</code>. zod validates inputs; errors are logged and sanitized.</p>
        </section>

        <section id="frontend-structure">
          <h2>Frontend Structure</h2>
          <ul>
            <li><code>src/app/**</code> — RSC pages; route handlers under <code>src/app/api/**</code>.</li>
            <li><code>src/components/**</code> — UI primitives and feature views (e.g., <code>clients-view</code>, <code>quote-editor</code>, <code>job-board</code>).</li>
            <li><code>src/components/providers/app-providers.tsx</code> sets up Query Client + Toaster.</li>
            <li><code>src/lib/**</code> — reusable utilities (currency, dates, calculations, schemas, http).</li>
          </ul>
        </section>

        <section id="services-layer">
          <h2>Services Layer</h2>
          <p>Pure functions in <code>src/server/services/*</code> implement workflows (CRUD, transitions, totals, activity logging) and shield route handlers from DB details.</p>
          <ul>
            <li><strong>invoices.ts</strong> — compute totals, manage payments, attachments, Stripe reconciliation, revert to quote.</li>
            <li><strong>quotes.ts</strong> — draft → status transitions, duplicate, convert, PDF.</li>
            <li><strong>jobs.ts</strong> — board snapshot, reorder, status updates, auto‑create for invoices.</li>
            <li><strong>settings.ts</strong> — singleton config with validation and side‑effects (numbering, activity).</li>
            <li><strong>exports.ts</strong> — CSV streaming for invoices/payments/jobs.</li>
            <li><strong>pdf/generator.ts</strong> — Puppeteer wrapper + templates.</li>
          </ul>
        </section>

        <section id="errors-logging">
          <h2>Errors & Activity Log</h2>
          <ul>
            <li><code>logger</code> emits structured JSON to console; production hides stacks.</li>
            <li><code>ActivityLog</code> records user‑visible events: settings updates, client/invoice changes, payments, Stripe events, job status.</li>
            <li>API errors return <code>{ error: { code, message, details? } }</code> with appropriate HTTP status.</li>
          </ul>
        </section>

        <section id="local-dev-lifecycle">
          <h2>Local Dev & Data Lifecycle</h2>
          <ul>
            <li><strong>Initialize</strong>: run migrations + seed; default settings, materials, printers appear.</li>
            <li><strong>Run</strong>: Next dev server; create/edit data via UI; files land under <code>data/</code>.</li>
            <li><strong>Restart</strong>: Processes reconnect to the same DB/files; nothing is lost unless <code>data/</code> is deleted.</li>
            <li><strong>Reset</strong>: Remove <code>data/</code> to start fresh; re‑seed if needed.</li>
          </ul>
        </section>

        <section id="data-safety">
          <h2>Data Safety Notes</h2>
          <p>
            Everything the app needs lives under <code>data/</code>. Copy that folder if you want an external backup, and replace it to restore. There is no separate backup automation inside the app.
          </p>
        </section>

        <section id="where-to-edit">
          <h2>Where To Edit What</h2>
          <ul>
            <li><strong>Business identity / tax / numbering</strong>: <code>src/server/services/settings.ts</code></li>
            <li><strong>Pricing math</strong>: <code>src/lib/calculations.ts</code> (line + document totals)</li>
            <li><strong>PDF layout</strong>: <code>src/server/pdf/templates/*</code> (HTML/CSS)</li>
            <li><strong>Invoice actions</strong>: <code>src/components/invoices/invoice-actions.tsx</code> and <code>src/app/api/invoices/**</code></li>
            <li><strong>Jobs board</strong>: <code>src/components/jobs/job-board.tsx</code> and <code>src/server/services/jobs.ts</code></li>
            <li><strong>CSV export</strong>: <code>src/server/services/exports.ts</code></li>
            <li><strong>Storage</strong>: <code>src/server/files/storage.ts</code> (attachments, PDFs)</li>
          </ul>
        </section>

        <section id="glossary">
          <h2>Glossary</h2>
          <ul>
            <li><strong>Local‑first</strong>: All data is stored locally under <code>data/</code> (no external DB).</li>
            <li><strong>RSC</strong>: React Server Components — server‑rendered pages that hydrate client views.</li>
            <li><strong>Decimal</strong>: Arbitrary precision type used to avoid floating‑point money errors.</li>
            <li><strong>Idempotent</strong>: Repeating an operation (e.g., webhook) won’t duplicate effects.</li>
          </ul>
        </section>

        <div class="hr"></div>
        <p class="small muted">This document summarizes the repository as of the current checkout. See <code>README.md</code>, <code>docs/build/*</code>, and <code>status/state.json</code> for progress notes.</p>
      </main>
    </div>
  </body>
  </html>
