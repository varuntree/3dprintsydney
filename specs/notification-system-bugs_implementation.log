# Notification System Bugs - Implementation Log

## Summary
Fixed 4 critical notification system issues to reduce cost, improve UX, and eliminate race conditions.

## Changes Implemented

### 1. Polling Frequency & Route-Based Disabling
**File:** `src/hooks/useShellNotifications.ts`
- Changed `POLL_INTERVAL_MS` from 5s to 30s (83% query reduction: 720/hr → 120/hr)
- Added comment explaining cost reduction rationale
- Disabled polling entirely when `isMessagesRoute = true` (line 302)
- Removed doubled interval logic - now uses constant 30s when polling enabled

### 2. Race Condition Fix
**File:** `src/hooks/useShellNotifications.ts`
- Added `markingSeenRef` flag (line 103) to prevent concurrent polling during mark-as-read
- Guard in `fetchNotifications` blocks polling when `markingSeenRef.current = true` (line 203)
- Set flag before PATCH request (line 348), clear in finally block (line 400)
- Ensures optimistic update completes before next poll

### 3. Removed Double markAllSeen Call
**File:** `src/components/notifications/notification-dropdown.tsx`
- Removed `markAllSeen()` call from `onOpenChange` close handler (line 85)
- Only explicit "Mark all read" button click triggers mark-as-read (line 138)
- Added comment explaining UX change

### 4. Filter Notifications on Messages Route
**File:** `src/hooks/useShellNotifications.ts`
- Early return in `fetchNotifications` when `isMessagesRoute = true` (lines 188-197)
- Returns empty state immediately without fetch
- Added `isMessagesRoute` to dependency array (line 263)

### 5. Event Debounce Optimization
**File:** `src/hooks/useShellNotifications.ts`
- Increased debounce from 150ms to 300ms (line 287)
- Reduces duplicate fetches from rapid event bursts
- Updated comment explaining behavior

## Validation

### TypeScript Check
```bash
npm run typecheck
```
**Result:** Pre-existing error in `src/app/(client)/client/page.tsx:13` (unrelated to notification changes)

### Manual Testing Required
Per spec requirements, these tests should be performed:

1. **Polling frequency:** Network tab should show `/api/notifications` max once per 30s
2. **Messages route:** Polling stops entirely when on `/messages`
3. **Real-time updates:** Event-driven updates still work (300ms debounced)
4. **Mark-read:** "Mark all read" clears notifications without flashing/reappearing
5. **Route filtering:** Bell badge clears when navigating to `/messages`

## Files Changed
- `src/hooks/useShellNotifications.ts` - Core logic fixes
- `src/components/notifications/notification-dropdown.tsx` - Remove double call

## Impact
- **Cost reduction:** 83% fewer queries (720/hr → 120/hr)
- **Additional savings:** Polling disabled on messages route
- **UX improvement:** No more notification flashing after mark-as-read
- **Clearer intent:** Users explicitly control mark-as-read action
- **Route awareness:** No redundant notifications when already viewing messages

## Notes
- Cannot use Supabase Realtime (free plan constraint)
- 30s polling acceptable for non-critical notifications
- Event system preserved for same-client optimistic updates
- Race condition eliminated via mutex-style flag pattern
